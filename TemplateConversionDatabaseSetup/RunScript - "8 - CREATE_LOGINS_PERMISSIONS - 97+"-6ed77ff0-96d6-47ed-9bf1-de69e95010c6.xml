<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option name='CLIENT_CODE' required='true' valuesUrl='file:/rundeckpro/optionProviders/ClientCodes.json' />
        <option name='PASSWORD_CRDADMIN' required='true' secure='true' valueExposed='true' />
      </options>
    </context>
    <description><![CDATA[Task_ID: 84

replace "SADN-CRD", "CRD_PROD_MAIN", and "password_crdadmin" with appropriate values
- use ctrl-h replace all so you don't miss any
 
This script is only run once, even in Test env.
For Test, use client_DEV1_MAIN for the DEFAULT_DATABASE parameter
 
For Password:
- must be randomly generated by Password Manager (Tools menu).
- set checkboxes for upper, lower, digits,
- Length = 12
 

--README:
-- *********************************
-- THIS SCRIPT IS ONLY APPROPRIATE FOR:
--   CRIMS 9.7 and above
--   SQL 2012 and above
-- *********************************
--These scripts are from the D:\CharlesRiver\dbadmin\scripts location.
--They are a combination of steps from MSSCreateDatabaseOwner.sql and MSSCreateMiddletierUser.sql, and needed updates to make the account a CRIMS Admin.
--Replace SADN-CRD with the actual user account
--Replace password_crdadmin with the actual password
--Replace CRD_PROD_MAIN with the actual database
--Replace CADN-PROD-CRD with actual domain account that has been created



<end of comment>]]></description>
    <dispatch>
      <excludePrecedence>true</excludePrecedence>
      <keepgoing>false</keepgoing>
      <rankOrder>ascending</rankOrder>
      <successOnEmptyNodeFilter>true</successOnEmptyNodeFilter>
      <threadcount>1</threadcount>
    </dispatch>
    <executionEnabled>true</executionEnabled>
    <group>TemplateConversionDatabaseSetup</group>
    <id>6ed77ff0-96d6-47ed-9bf1-de69e95010c6</id>
    <loglevel>INFO</loglevel>
    <name>RunScript - "8 - CREATE_LOGINS_PERMISSIONS - 97+"</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <nodefilters>
      <filter>tags:CRIMS,Test</filter>
    </nodefilters>
    <nodesSelectedByDefault>false</nodesSelectedByDefault>
    <scheduleEnabled>true</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>Run script "8 - CREATE_LOGINS_PERMISSIONS - 97+"</description>
        <fileExtension>ps1</fileExtension>
        <script><![CDATA[Invoke-sqlcmd -query "
USE MASTER 
GO
IF NOT EXISTS (SELECT name FROM master.sys.server_principals WHERE name = 'SADN-@option.CLIENT_CODE@')
BEGIN
CREATE LOGIN [SADN-@option.CLIENT_CODE@] WITH PASSWORD=N'@option.PASSWORD_CRDADMIN@', DEFAULT_DATABASE=@option.CLIENT_CODE@_DEV1_MAIN, CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GRANT VIEW SERVER STATE TO [SADN-@option.CLIENT_CODE@]
CREATE USER [SADN-@option.CLIENT_CODE@] FROM LOGIN [SADN-@option.CLIENT_CODE@]
GRANT CREATE DATABASE TO [SADN-@option.CLIENT_CODE@]
END
GO

USE @option.CLIENT_CODE@_DEV1_MAIN;
GO

-- Change the database owner of the CRIMS database to the new user
EXEC dbo.sp_changedbowner @loginame = N'SADN-@option.CLIENT_CODE@', @map = false;
GO

-- Insert required user information into PDF_USER.
INSERT INTO PDF_USER(USER_CD,USER_NAME,INIT,EMAIL_ADDR,LOCK_IND,ACTIVE_IND,DM_IND, SUPER_USER_IND, EXT_USER_NAME)
VALUES( 'SADN-@option.CLIENT_CODE@','SADN-@option.CLIENT_CODE@','SADN-@option.CLIENT_CODE@','noreply@localhost','N','Y','N','Y','CADN-TEST-UPG');

-- Add the user to ALLUSERS group --
IF EXISTS  (SELECT 1 FROM PDF_GROUP WHERE GRP_CD = 'ALLUSERS')
INSERT INTO PDF_USER_GROUP ( GRP_CD, USER_CD, DEFAULT_GROUP_IND, MENU_GROUP )
VALUES( 'ALLUSERS', 'SADN-@option.CLIENT_CODE@', 'N', 'N' );
GO

-- Add the user to SYS_ADMINS group -- 
IF EXISTS  (SELECT 1 FROM PDF_GROUP WHERE GRP_CD = 'SYS_ADMINS')
    INSERT INTO PDF_USER_GROUP ( GRP_CD, USER_CD, DEFAULT_GROUP_IND, MENU_GROUP ) VALUES( 'SYS_ADMINS', 'SADN-@option.CLIENT_CODE@', 'Y', 'N' );
GO

-- Add the user to ANYWHERE_ADMINS group -- 
IF EXISTS  (SELECT 1 FROM PDF_GROUP WHERE GRP_CD = 'ANYWHERE_ADMINS')
    INSERT INTO PDF_USER_GROUP ( GRP_CD, USER_CD, DEFAULT_GROUP_IND, MENU_GROUP ) VALUES( 'ANYWHERE_ADMINS', 'SADN-@option.CLIENT_CODE@', 'N', 'N' );
GO

-- Add the user to CRD_MT_USERS group --
IF EXISTS  (SELECT 1 FROM PDF_GROUP WHERE GRP_CD = 'CRD_MT_USERS')
    INSERT INTO PDF_USER_GROUP ( GRP_CD, USER_CD, DEFAULT_GROUP_IND, MENU_GROUP ) VALUES( 'CRD_MT_USERS', 'SADN-@option.CLIENT_CODE@', 'N', 'N' );
GO

-- Add the user to CRD_DBA group
IF EXISTS  (SELECT 1 FROM PDF_GROUP WHERE GRP_CD = 'CRD_DBA')
    INSERT INTO PDF_USER_GROUP ( GRP_CD, USER_CD, DEFAULT_GROUP_IND, MENU_GROUP ) VALUES( 'CRD_DBA', 'SADN-@option.CLIENT_CODE@', 'N', 'N' );
GO
" -verbose]]></script>
        <scriptargs />
      </command>
    </sequence>
    <uuid>6ed77ff0-96d6-47ed-9bf1-de69e95010c6</uuid>
  </job>
</joblist>
