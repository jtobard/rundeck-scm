<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option delimiter=',' multivalued='true' name='TARGET_PATH' required='true'>
          <description><![CDATA[1. https://upg-t1.ms.crd.com:8081/crts
2. https://upg-t1.ms.crd.com:8082/crts
3. https://upg-t1.ms.crd.com:8083/crts]]></description>
        </option>
      </options>
    </context>
    <description><![CDATA[Task_ID: 104
Update the properties for the link to to use the following which should match the DNS entry for the machine:
 
Test: https://<CLIENT CODE>-<ENV LETTER><NUMBER>.ms.crd.com
 
Prod: https://<CLIENT CODE>-<ENV LETTER><NUMBER>.ms.crd.com
 
DR: https://<CLIENT CODE>-<ENV LETTER><NUMBER>.ms.crd.com]]></description>
    <dispatch>
      <excludePrecedence>true</excludePrecedence>
      <keepgoing>false</keepgoing>
      <rankOrder>ascending</rankOrder>
      <successOnEmptyNodeFilter>true</successOnEmptyNodeFilter>
      <threadcount>1</threadcount>
    </dispatch>
    <executionEnabled>true</executionEnabled>
    <group>TemplateConversionDatabaseSetup</group>
    <id>53bda283-c43f-4fe8-8aa7-cb04d0a5e74e</id>
    <loglevel>INFO</loglevel>
    <name>WebAdminShortcut</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <nodefilters>
      <filter>tags:CRIMS,Test</filter>
    </nodefilters>
    <nodesSelectedByDefault>false</nodesSelectedByDefault>
    <scheduleEnabled>true</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>Verify target path for Web admin shortcut </description>
        <fileExtension>ps1</fileExtension>
        <script><![CDATA[#This is part of the vm checkout
#Date: 10/19/2017
#Author: Weijie Lin
#Description: This script is used to modify web admin shortcut
#Param (Rundeck Option): @option.TARGET_PATH@
#        1. Test: https://-.ms.crd.com
#        2. Prod: https://-.ms.crd.com
#        3.DR: https://-.ms.crd.com
[CmdletBinding()]
Param(

    [Parameter(Position=0)]
    [string[]]$target_path
)
Write-Host "******** Ensure target path for Web admin shortcut ********"
$webadmins = Get-ChildItem -Recurse "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Charles River*\Middle Tier port*\Admin*.lnk"
$shell = New-Object -COM WScript.Shell
Foreach ($target in $target_path.Split(',') ){
    $target_url = $target | Select-String -Pattern ":(\d+)"
    $target_port = $target_url.Matches.Groups[1].ToString()
    $webadmin = Get-ChildItem -Recurse "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Charles River*\Middle Tier port $target_port\Admin*.lnk"
    $shortcut = $shell.CreateShortcut($webadmin.FullName)  ## Open the lnk
    $shortcut.TargetPath = "C:\Program Files\Internet Explorer\iexplore.exe"  ## Make changes
    $shortcut.Arguments = $target
    $shortcut.Save()  ## Save
    If($shortcut.TargetPath -eq "C:\Program Files\Internet Explorer\iexplore.exe" -and $shortcut.Arguments -eq $target){
        Write-Host "Target path is set on Middle Tier $target_port"
    }Else{
        Write-Host "Target path was not set correctly on Middle Tier $target_port"
        exit 1
    }
}

Write-Host "******** End of Script ********"
exit 0]]></script>
        <scriptargs>${option.TARGET_PATH}</scriptargs>
      </command>
    </sequence>
    <uuid>53bda283-c43f-4fe8-8aa7-cb04d0a5e74e</uuid>
  </job>
</joblist>
